{% extends "base.html" %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">ğŸ–¼ï¸ Flux Image Gallery</h1>

<div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>

<div id="loading" class="text-center text-gray-400 mt-4 hidden">Loading more images...</div>
<div id="end-message" class="text-center text-gray-500 mt-4 hidden">No more images.</div>

<script>
  let page = 1;
  const limit = 20;
  let loading = false;
  let hasNext = true;

  async function loadImages() {
    if (loading || !hasNext) return;
    loading = true;
    document.getElementById('loading').classList.remove('hidden');

    const res = await fetch(`/flux/gallery/json?page=${page}&limit=${limit}`);
    const data = await res.json();

    const grid = document.getElementById('gallery-grid');
    data.images.forEach(img => {
      const link = document.createElement('a');
      link.href = img.detail_url;
      link.className = 'block bg-gray-800 rounded shadow hover:bg-gray-700';

      link.innerHTML = `
        <img src="${img.thumbnail_url}" alt="${img.filename}" 
          class="w-full h-[200px] object-cover rounded-t bg-gray-900" loading="lazy">
        <div class="p-2 text-xs text-gray-300 truncate">${img.filename}</div>
      `;
      grid.appendChild(link);
    });

    document.getElementById('loading').classList.add('hidden');

    hasNext = data.has_next;
    if (!hasNext) {
      document.getElementById('end-message').classList.remove('hidden');
    }

    page++;
    loading = false;
  }

  // Load initial images
  loadImages();

  // Infinite scroll
  window.addEventListener('scroll', () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 300) {
      loadImages();
    }
  });
</script>
{% endblock %}
